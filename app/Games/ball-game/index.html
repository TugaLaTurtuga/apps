<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ball Game</title>
    <link rel="icon" href="icon.webp" type="image/webp" />

    <!-- Connect to external programs -->
    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Radio+Canada&amp;display=swap" rel="stylesheet">
    <!-- Preconnect to cloudflare -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

    <style>
        :root {
            --PrimaryColor: rgb(237, 140, 5);
            --SecundaryColor: rgb(50, 50, 50);
            --background1: rgb(255,255,255);
            --background2: rgb(225,225,225);
            --BtnBack: rgb(50,50,50);
            --BtnBodyBack1: rgb(245,245,245);
            --BtnBodyBack2: rgb(225,225,225); 
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: auto;
            width: auto;
            margin: 0;
            flex-direction: column;
            font-family: 'Radio Canada', sans-serif;
        }
        canvas {
            border-radius: 20px;
            width: 0px;
            height: auto;
            font-family: 'Radio Canada', sans-serif;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .ads {
            margin: 30px;
            text-align: center;
        }
        .download-div{
            margin-bottom: 10px;
        }
        .controls {
            margin-bottom: 10px;
            border-radius: 5px;
            padding: 5px;
            font-family: 'Radio Canada', sans-serif;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        button{
            border-radius: 5px;
            padding: 5px;
            border-color: var(--PrimaryColor);
            background-color: var(--BtnBodyBack1);
            color: black;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        button:hover{
            border-color: var(--SecundaryColor);
            background-color: var(--BtnBodyBack2);
        }
        input{
            padding: 10px;
            margin-right: 10px;
            border-radius: 5px;
            border-color: var(--SecundaryColor);
            background-color: var(--BtnBodyBack1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2)
        }
        input:hover{
            border-color: var(--PrimaryColor);
            background-color: var(--BtnBodyBack2);
        }
        .input-text{
            padding: 10px;
            width: 92%;
            place-content: center;
            margin-right: 0px;
        }
        #leaderboard {
            display: none;
            position: fixed;
            text-align: center;
            background-color: #ffffff;
            padding: 10px;
            font-size: 16px;
            border-radius: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #chossen-leaderboard {
            margin-top: -28px;
            color: var(--BtnBack);
            font-size: 12px;
            text-align: center;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #leaderboard-list {
            text-align: left;
            margin-bottom: 10px;
        }

        #player-name-container {
            display: block;
            margin-bottom: 10px;
            border-radius: 5px;
            padding: 10px;
            width: 20%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        #time-container{
            display: none;
            border-radius: 10px;
            margin-bottom: -11px;
            font-size: 16px;
            font-family: 'Radio Canada', sans-serif;
            font-weight: 600;
            height: 25px;
            padding: 10px;
            padding-top: 0px;
            padding-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #stop-container{
            display: none;
            border-radius: 10px;
            margin-top: -11px;
            font-size: 24px;
            font-family: sans-serif;
            color: red;
            font-weight: 600;
            height: 25px;
            padding-top: 5px;
            padding-bottom: 3px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .stop-button{
            width: 100%;
            height: 150%;
            padding: 40px;
            margin-top: -5px;
            padding-top: 0px;
            padding-bottom: 0px;
            font-size: 16px;
            color: red;
            background-color: #ffffff;
            border-width: 0 ;
            border-color: #ffffff;
            font-family: sans-serif;
            font-weight: 600;
        }
        .stop-button:hover{
            background-color: #ffffff;
            border-color: #ffffff;
        }
    </style>
</head>
<body>
    <!-- Download for pc btn -->
     <div class="download-div">
        <a href="https://github.com/TugaLaTurtuga/Ball-game/archive/refs/heads/main.zip", target="_blank">
            <button> Download game (for pc) </button>
        </a>
     </div>

    <!-- Game Controls -->
    <div class="controls">
        <label for="rows">Rows:</label>
        <input type="number" id="rows" value="7" min="3" max="10" onchange="start()">
        <label for="cols">Cols:</label>
        <input type="number" id="cols" value="5" min="3" max="10" onchange="start()">
        <button onclick="openOrCloseLeaderboard()">Show Leaderboard</button>
    </div>     

    <!-- Player Name Input -->
    <div id="player-name-container">
        <input type="text" id="player-name" class="input-text" placeholder="Enter your name (optional)">
    </div>

    <!-- Game time container -->
    <div id="time-container"></div>

    <!-- Game Canvas -->
    <main></main>

    <!-- Leaderboard -->
    <div id="leaderboard">
        <h2>Leaderboard</h2>
        <div id="chossen-leaderboard"></div>
        <div id="leaderboard-list"></div>
        <button onclick="hideLeaderboard()">Close</button>
    </div>

    <!-- Stop game container (reloads page) -->
    <div id="stop-container">
        <button class="stop-button" onclick="location.reload();">Stop</button>
    </div>

    <!-- Ads -->
    <div class="ads">
        <script 
            async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1113318967174224"
            crossorigin="anonymous">
        </script>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1234567890123456" crossorigin="anonymous"></script>
        <!-- Homepage Leaderboard -->
        <ins class="adsbygoogle"
        style="display:inline-block;width:728px;height:90px"
        data-ad-client="ca-pub-1234567890123456"
        data-ad-slot="1234567890"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- Game code -->
    <script>
        let rows = 7;
        let cols = 5;
        let margin = 10;
        let padding = 5;
        let cellSize;
        let virtualBoard = [];
        let buttonRects = [];
        let currentNumber = 0;
        let finished = false;
        let time = 0;
        let startTime = null;
        let extraMarginTop;
        let colors = ["#FF5733", "#33FF57", "#3357FF", "#FF33A6", "#A633FF", "#33FFF6", "#F6FF33", "#FF8A33", "#8AFF33", "#33FF99"];
        let leaderboard = [];
        let playerName = 'anonymous';
        let TimeSrting = '';
        let leaderboardIsOpen = false;
        let gameStarted = false;
        let canClick = true;

        function start() {
            gameStarted = true;
            rows = parseInt(document.getElementById('rows').value);
            cols = parseInt(document.getElementById('cols').value);
            document.getElementById("time-container").style.display = 'block';
            document.getElementById("stop-container").style.display = 'block';
            virtualBoard = [];
            currentNumber = 0;
            finished = false;
            startTime = null;
            setup();
        }

        function setup() {
            cellSize = 75 - ((cols / 4) + (rows / 2)) * 5;
            extraMarginTop = cellSize;
            let canvasWidth = cellSize * (cols + 1) + padding * (cols - 4) - margin;
            let canvasHeight = cellSize * (rows + 1) + extraMarginTop / 2 + 2 + margin;
            createCanvas(canvasWidth, canvasHeight);
            frameRate(244);
            initializeBoard();
            textFont('Radio Canada');
            loop();
        }

        function draw() {
            if (!gameStarted) {
                background(255);
                createCanvas(100, 100)
                textSize(16);
                textAlign(CENTER, CENTER);
                fill(0);
                text('Start Game', width / 2, height / 2);
                return;
            }
            drawTimer();
            background(255);
            drawGrid();
            drawBalls();
            drawSelectedBall();
            if (finished) {
                drawRestartButton();
                endGame();
            }
        }

        function initializeBoard() {
            let totalCells = rows * cols;
            let maxNumber = cols - 1; // This determines the highest number to be used
            let maxOccurrences = rows;

            let numbers = [];
            for (let num = 1; num <= maxNumber; num++) {
                numbers.push(...Array(maxOccurrences).fill(num));
            }

            numbers = shuffle(numbers);

            for (let col = 0; col < cols; col++) {
                let newRow = [];
                for (let row = 0; row < rows; row++) {
                    if (col === cols - 1) {
                        newRow.push(0); // Last column should be all zeros
                    } else {
                        newRow.push(numbers.pop());
                    }
                }
                virtualBoard.push(newRow);
            }
        }

        function drawGrid() {
            strokeWeight(5);
            stroke(0);
            for (let col = 0; col <= cols; col++) {
                let startY = height - margin;
                let x = margin + col * (cellSize + padding);
                line(x, startY, x, startY - cellSize * rows);
            }
        }

        function drawBalls() {
            buttonRects = [];
            let xStart = margin + cellSize / 2 + 2.5;
            let yStart = margin + extraMarginTop / 1.2 + cellSize;

            // Iterate over columns and rows to draw ellipses
            for (let col = 0; col < cols; col++) {
                let x = xStart + col * (cellSize + padding);
               for (let row = 0; row < rows; row++) {
                   let y = yStart + row * (cellSize);
                   let number = virtualBoard[col][rows - 1 - row];

                   if (number !== 0) {
                      if (colors[number] === undefined) {
                            colors[number] = color(random(255), random(255), random(255));
                        }
                        fill(colors[number]);
                        ellipse(x, y, cellSize - padding, cellSize - padding);
                    }
                }

                // Calculate the rectangle corresponding to this column
                let rectX = margin + col * (cellSize + padding);
                let rectY = margin + extraMarginTop * 1.5;
                let rectW = cellSize;
                let rectH = height - margin * 2 - extraMarginTop * 1.5;

                buttonRects.push(new Rect(rectX, rectY, rectW, rectH));
            }
        }

        function drawSelectedBall() {
            if (currentNumber !== 0) {
                let y = margin + padding + cellSize / 2;
                let x = mouseX;
                fill(colors[currentNumber]);
                ellipse(x, y, cellSize - padding / 2, cellSize - padding / 2);
            }
        }

        function drawTimer() {
            if (startTime !== null) {
                time = (millis() - startTime) / 1000;
            } else {
                time = 0;
            }

            // Define the text to be displayed
            TimeSrting = nf(time, 0, 2);

            let timercontainer = document.getElementById("time-container");
            timercontainer.innerHTML = `<h3>[Time: ${TimeSrting}]</h3>`;
        }

        function drawRestartButton() {
            let buttonWidth = 200;
            let buttonHeight = 50;
            let buttonX = (width - buttonWidth) / 2;
            let buttonY = (height - buttonHeight) / 2;
            fill(95, 150, 255);
            let textSizeValue = 32;
            textSize(textSizeValue);
            textFont('Radio Canada');
            textAlign(CENTER, CENTER);
            text('Try again', buttonX + buttonWidth / 2, buttonY + buttonHeight / 2);
        }

        function mousePressed() {
            if (!canClick) {
                return;
            }
            else if (!gameStarted) {
                let buttonWidth = width;
                let buttonHeight = height;
                let buttonX = (width - buttonWidth) / 2;
                let buttonY = (height - buttonHeight) / 2;
                if (mouseX >= buttonX && mouseX <= buttonX + buttonWidth && mouseY >= buttonY && mouseY <= buttonY + buttonHeight) {
                    start();
                }
                return;
            }
            else if (finished) {
                let buttonWidth = 200;
                let buttonHeight = 50;
                let buttonX = (width - buttonWidth) / 2;
                let buttonY = (height - buttonHeight) / 2;
                if (mouseX >= buttonX && mouseX <= buttonX + buttonWidth && mouseY >= buttonY && mouseY <= buttonY + buttonHeight) {
                    start();
                }
                return;
            }
            for (let col = 0; col < buttonRects.length; col++) {
                let rect = buttonRects[col];
                if (rect.contains(mouseX, mouseY)) {
                    if (currentNumber === 0) {
                        for (let row = rows - 1; row >= 0; row--) {
                            let number = virtualBoard[col][row];
                            if (number !== 0) {
                                virtualBoard[col][row] = 0;
                                currentNumber = number;
                                
                                if (startTime === null) {
                                    startTime = millis();
                                }
                                
                                break;
                            }
                        }
                    } else {
                        for (let row = 0; row < rows; row++) {
                            let number = virtualBoard[col][row];
                            if (number === 0) {
                                virtualBoard[col][row] = currentNumber;
                                currentNumber = 0;
                                checkWinCondition();
                                break;
                            }
                        }
                    }
                    break;
                }
            }
        }

        function checkWinCondition() {
            let won = true;
            for (let col = 0; col < cols; col++) {
                let number = virtualBoard[col][rows - 1];
                for (let row = 0; row < rows; row++) {
                    if (virtualBoard[col][row] !== number) {
                        won = false;
                        break;
                    }
                }
            }
            if (won) {
                finished = true;
                noLoop();
            }
        }

        function endGame() {
            if (finished) {
                // Save leaderboard for the specific configuration
                let leaderboardKey = `leaderboard_${rows}_${cols}`;
                let playerName = document.getElementById('player-name').value.trim() || 'anonymous';
                let score = TimeSrting;
                
                leaderboard = JSON.parse(localStorage.getItem(leaderboardKey)) || [];
                leaderboard.push({ name: playerName, score: score });
                leaderboard.sort((a, b) => a.score - b.score);
                leaderboard = leaderboard.slice(0, 10);
                
                localStorage.setItem(leaderboardKey, JSON.stringify(leaderboard));
            }
        }

        function openOrCloseLeaderboard(){
            if (leaderboardIsOpen) {
                hideLeaderboard()
            }
            else {
                showLeaderboard()
            }
        }

        function showLeaderboard() {
            let leaderboardKey = `leaderboard_${rows}_${cols}`;
            leaderboard = JSON.parse(localStorage.getItem(leaderboardKey)) || [];
            document.getElementById('leaderboard').style.display = 'block';
            updateLeaderboardDisplay();
            leaderboardIsOpen = true;
            canClick = false;
            
        }

        function hideLeaderboard() {
            document.getElementById('leaderboard').style.display = 'none';
            leaderboardIsOpen = false;

            // Set canClick to true after 10ms
            setTimeout(() => {
                canClick = true;
            }, 10);
        }

        function updateLeaderboardDisplay() {
            let Chossenleaderboard = document.getElementById('chossen-leaderboard');
            Chossenleaderboard.innerHTML = `<h3>[Rows: ${rows}, Cols: ${cols}]</h3>`;

            let leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            leaderboard.forEach(entry => {
                let entryDiv = document.createElement('div');
                entryDiv.textContent = `${entry.name}: ${entry.score}`;
                leaderboardList.appendChild(entryDiv);
            });
        }

        class Rect {
            constructor(x, y, w, h) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
            }
            
            contains(px, py) {
                return px >= this.x && px <= this.x + this.w && py >= this.y && py <= this.y + this.h;
            }
        }

        // Load leaderboard from local storage on page load
        window.onload = function() {
            // No need to initialize leaderboard here anymore
        };
    </script>
</body>
</html>
